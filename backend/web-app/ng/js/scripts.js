"use strict";angular.module("frontendApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","ui-templates","angularFileUpload","ui.growl","truncate"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl",reloadOnSearch:!1}).when("/event/:eventId",{templateUrl:"views/event.html",controller:"EventCtrl"}).when("/panel/:instId",{templateUrl:"views/panel.html",controller:"PanelCtrl",reloadOnSearch:!1,resolve:{checkLoggedin:["Auth",function(a){return a.assert()}]}}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/rc/invalid",{templateUrl:"views/invalidConfirmation.html",controller:"InvalidConfirmationCtrl"}).when("/rc/signup/:type",{templateUrl:"views/signupConfirmation.html",controller:"SignupConfirmationCtrl"}).when("/rc/setPwd/:token/:username",{templateUrl:"views/setPwd.html",controller:"SetPwdCtrl"}).otherwise({redirectTo:"/"}),b.interceptors.push("ResponseInterceptor")}]).run(["$location","$rootScope","I18n","$growl","$modalStack","$route",function(a,b,c,d,e,f){b.i18n=c,b.userId=-666,b.$on("onAuthenticationSuccess",function(a,c){b.userId=c.id,b.username=c.username}),b.$on("onLogoutSuccess",function(){b.userId=-666}),b.$on("$routeChangeError",function(a,b,c,d){d&&666===d.status&&g(d)}),b.$on("onUnexpectedServerError",function(a,b){var e;switch(b.status){case 401:case 403:g();break;case 404:e=c.error.status404;break;case 0:e=c.error.status0;break;default:e=c.error.unexpected}return e&&d.box(null,e,{"class":"danger",sticky:!1,timeout:1e4}).open()});var g=function(){if("/"!==a.path()){e.dismissAll();var b=f.current.params;a.url("login"),delete b.instId,a.search(b)}}}]),angular.module("frontendApp").directive("ngThumb",["$window",function(a){var b={support:!(!a.FileReader||!a.CanvasRenderingContext2D),isFile:function(b){return angular.isObject(b)&&b instanceof a.File},isImage:function(a){var b="|"+a.type.slice(a.type.lastIndexOf("/")+1)+"|";return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(b)}};return{restrict:"A",template:"<canvas/>",link:function(a,c,d){function e(a){var b=new Image;b.onload=g,b.src=a.target.result}if(b.support){var f=a.$eval(d.ngThumb);if(b.isFile(f.file)&&b.isImage(f.file)){var g=function(){var a=f.width||this.width/this.height*f.height,b=f.height||this.height/this.width*f.width;h.attr({width:a,height:b}),h[0].getContext("2d").drawImage(this,0,0,a,b)},h=c.find("canvas"),i=new FileReader;i.onload=e,i.readAsDataURL(f.file)}}}}}]),angular.module("frontendApp").directive("ngSameAs",["$parse",function(a){return{require:"ngModel",link:function(b,c,d,e){var f=a(d.ngSameAs);e.$parsers.push(function(a){return e.$isEmpty(a)||a===f(b)?(e.$setValidity("sameAs",!0),a):(e.$setValidity("sameAs",!1),void 0)})}}}]),angular.module("frontendApp").directive("ngServerError",function(){return{require:"ngModel",link:function(a,b,c,d){var e=c.ngServerErrorName?c.ngServerErrorName:d.$name;a.$on("serverErrorOccurred-"+e,function(a,b){d.$error.errorText=b,d.$setValidity("server",!1)}),d.$parsers.unshift(function(a){return d.$setValidity("server",!0),a})}}}),angular.module("ui.bootstrap.timepicker",[]).constant("timepickerConfig",{hourStep:1,minuteStep:1,showMeridian:!0,meridians:null,readonlyInput:!1,mousewheel:!0}).directive("timepicker",["$parse","$log","timepickerConfig","$locale",function(a,b,c,d){return{restrict:"EA",require:"?^ngModel",replace:!0,scope:{},templateUrl:"template/timepicker/timepicker.html",link:function(e,f,g,h){function i(){var a=parseInt(e.hours,10),b=e.showMeridian?a>0&&13>a:a>=0&&24>a;return b?(e.showMeridian&&(12===a&&(a=0),e.meridian===q[1]&&(a+=12)),a):void 0}function j(){var a=parseInt(e.minutes,10);return a>=0&&60>a?a:void 0}function k(a){return angular.isDefined(a)&&a.toString().length<2?"0"+a:a}function l(a){m(),h.$setViewValue(new Date(p)),n(a)}function m(){h.$setValidity("time",!0),e.invalidHours=!1,e.invalidMinutes=!1}function n(a){var b=p.getHours(),c=p.getMinutes();e.showMeridian&&(b=0===b||12===b?12:b%12),e.hours="h"===a?b:k(b),e.minutes="m"===a?c:k(c),e.meridian=p.getHours()<12?q[0]:q[1]}function o(a){var b=new Date(p.getTime()+6e4*a);p.setHours(b.getHours(),b.getMinutes()),l()}if(h){var p=h.$modelValue?new Date(h.$modelValue):new Date,q=angular.isDefined(g.meridians)?e.$parent.$eval(g.meridians):c.meridians||d.DATETIME_FORMATS.AMPMS,r=c.hourStep;g.hourStep&&e.$parent.$watch(a(g.hourStep),function(a){r=parseInt(a,10)});var s=c.minuteStep;g.minuteStep&&e.$parent.$watch(a(g.minuteStep),function(a){s=parseInt(a,10)}),e.showMeridian=c.showMeridian,g.showMeridian&&e.$parent.$watch(a(g.showMeridian),function(a){if(e.showMeridian=!!a,h.$error.time){var b=i(),c=j();angular.isDefined(b)&&angular.isDefined(c)&&(p.setHours(b),l())}else n()});var t=f.find("input"),u=t.eq(0),v=t.eq(1),w=angular.isDefined(g.mousewheel)?e.$eval(g.mousewheel):c.mousewheel;if(w){var x=function(a){a.originalEvent&&(a=a.originalEvent);var b=a.wheelDelta?a.wheelDelta:-a.deltaY;return a.detail||b>0};u.bind("mousewheel wheel",function(a){e.$apply(x(a)?e.incrementHours():e.decrementHours()),a.preventDefault()}),v.bind("mousewheel wheel",function(a){e.$apply(x(a)?e.incrementMinutes():e.decrementMinutes()),a.preventDefault()})}if(e.readonlyInput=angular.isDefined(g.readonlyInput)?e.$eval(g.readonlyInput):c.readonlyInput,e.readonlyInput)e.updateHours=angular.noop,e.updateMinutes=angular.noop;else{var y=function(a,b){h.$setViewValue(null),h.$setValidity("time",!1),angular.isDefined(a)&&(e.invalidHours=a),angular.isDefined(b)&&(e.invalidMinutes=b)};e.updateHours=function(){var a=i();angular.isDefined(a)?(p.setHours(a),l("h")):y(!0)},u.bind("blur",function(){!e.validHours&&e.hours<10&&e.$apply(function(){e.hours=k(e.hours)})}),e.updateMinutes=function(){var a=j();angular.isDefined(a)?(p.setMinutes(a),l("m")):y(void 0,!0)},v.bind("blur",function(){!e.invalidMinutes&&e.minutes<10&&e.$apply(function(){e.minutes=k(e.minutes)})})}h.$render=function(){var a=h.$modelValue?new Date(h.$modelValue):null;isNaN(a)?(h.$setValidity("time",!1),b.error('Timepicker directive: "ng-model" value must be a Date object, a number of milliseconds since 01.01.1970 or a string representing an RFC2822 or ISO 8601 date.')):(a&&(p=a),m(),n())},e.incrementHours=function(){o(60*r)},e.decrementHours=function(){o(60*-r)},e.incrementMinutes=function(){o(s)},e.decrementMinutes=function(){o(-s)},e.toggleMeridian=function(){o(720*(p.getHours()<12?1:-1))}}}}}]),angular.module("frontendApp").directive("ngDateFix",function(){return{restrict:"EA",require:"ngModel",link:function(a,b,c,d){var e=c.datepickerPopup;d.$parsers.push(function(b){var f=b;if(d.$isEmpty(f)||"string"!=typeof f||"dd-MM-yyyy"!==e)return f;var g=f.split("-"),h=parseInt(g[0]),i=parseInt(g[1])-1,j=parseInt(g[2]),k=new Date;k.setFullYear(j,i,h);var l=a[c.max],m=a[c.min];return isNaN(k.getTime())||j!==k.getFullYear()||i!==k.getMonth()||h!==k.getDate()||l&&k>l||m&&m>k?(d.$setValidity("date",!1),k=void 0):(d.$setValidity("date",!0),d.$setViewValue(k)),k})}}}),angular.module("frontendApp").directive("ngFormAutofillFix",function(){return function(a,b,c){b.prop("method","POST"),c.ngSubmit&&setTimeout(function(){b.unbind("submit").submit(function(d){d.preventDefault(),b.find("input, textarea, select").trigger("input").trigger("change").trigger("keydown"),a.$apply(c.ngSubmit)})},0)}}),angular.module("frontendApp").directive("infoPanel",function(){return{restrict:"E",templateUrl:"template/infoPanel/infoPanel.html",scope:{panel:"=panel",form:"=form"}}}),angular.module("frontendApp").directive("ngClearFix",function(){return{link:function(a,b,c){a.$watch(c.ngModel,function(a){a||$(b).val(null)})}}});var app=angular.module("frontendApp"),serwerUrl="",url=function(a){return serwerUrl+a},AUTH_TOKEN_NAME="X-XSRF-TOKEN";app.factory("Menu",["$http",function(a){return{week:function(){return a.get(url("menu/week.json")).then(function(a){return a.data})},categories:function(){return a.get(url("menu/categories.json")).then(function(a){return a.data})}}}]),app.factory("Config",["$http",function(a){return{now:function(){return a.get(url("config/now.json")).then(function(a){return a.data})}}}]),app.factory("Category",["$http",function(a){return{all:function(){return a.get(url("category/all.json")).then(function(a){return a.data})}}}]),app.factory("Events",["$http",function(a){return{byDate:function(b,c,d){return a.get(url("evntProj/byDate/"+b+".json"),{params:{category:c,inst:d}}).then(function(a){return a.data})},byId:function(b){return a({method:"GET",url:url("evntProj/byEvent/"+b+".json")}).then(function(a){return a.data})},submitted:function(b){return a.get(url("evntProj/submitted/"+b+".json")).then(function(a){return a.data})}}}]),app.factory("Inst",["$resource",function(a){return a(url("inst/:id.json"),null,{update:{method:"PUT"}})}]),app.factory("Event",["$resource",function(a){return a(url("event/:id.json"),null,{update:{method:"PUT"}})}]),app.factory("Insts",["$http",function(a){return{names:function(){return a.get(url("instProj/names.json")).then(function(a){return a.data})}}}]),app.factory("Uploader",["$fileUploader","$http",function(a,b){return{create:function(c){var d={};return d[AUTH_TOKEN_NAME]=b.defaults.headers.common[AUTH_TOKEN_NAME],a.create({scope:c,url:url("upload/evntPic"),removeAfterUpload:!1,headers:d})}}}]),app.factory("Auth",["$rootScope","$http","$q","$timeout","$cookies","$window",function(a,b,c,d,e,f){return{login:function(c,d){return b.post(url("xhr/login.json"),c).then(function(c){if(e[AUTH_TOKEN_NAME]=b.defaults.headers.common[AUTH_TOKEN_NAME]=c.data.token,d){var g=c.data.username,h=new Date;h.setTime(h.getTime()+2592e6);var i="expires="+h.toGMTString();f.document.cookie="username="+g+"; "+i}else delete e.username;return a.$broadcast("onAuthenticationSuccess",c.data),c.data})},assert:function(){var f=!1,g=b.defaults.headers.common;if(!g[AUTH_TOKEN_NAME]){var h=e[AUTH_TOKEN_NAME];if(!h){var i=c.defer();return d(function(){i.reject({status:666})},0),i.promise}g[AUTH_TOKEN_NAME]=h,f=!0}return b.get(url("xhr/checkLogin.json")).then(function(b){f&&a.$broadcast("onAuthenticationSuccess",b.data)})},checkIfLoggedIn:function(){var c=b.defaults.headers.common;if(!c[AUTH_TOKEN_NAME]){var d=e[AUTH_TOKEN_NAME];if(d)return c[AUTH_TOKEN_NAME]=d,b.get(url("xhr/checkLogin.json")).then(function(b){a.$broadcast("onAuthenticationSuccess",b.data)})}},logout:function(){return b.post(url("xhr/logout")).then(function(){return delete e[AUTH_TOKEN_NAME],delete b.defaults.headers.common[AUTH_TOKEN_NAME],a.$broadcast("onLogoutSuccess"),!0})},resetPwd:function(a){return b.post(url("pwd/reset.json"),a)},setPwd:function(a){return b.post(url("pwd/set.json"),a)},changePwd:function(a){return b.post(url("pwd/change.json"),a)}}}]),angular.module("frontendApp").factory("MsgPanel",["$window",function(a){return{show:function(b,c,d,e){var f=[];return d&&(f=angular.isArray(d)?d:[d]),f.length?(b.type=c,b.messages=f,b.show=!0,e&&e.$setPristine&&e.$setPristine(),a.scrollTo(0,0)):b.show=!1,b.show},showError:function(a,b,c){return this.show(a,"danger",b,c)},showSuccess:function(a,b,c){return this.show(a,"success",b,c)},hide:function(a){a.messages=[],a.show=!1}}}]),angular.module("frontendApp").factory("Progressbar",["$modal","$rootScope",function(a,b){return{open:function(){if(!b.$progress){var c=b.$progress=a.open({templateUrl:"template/loadingbar/loadingbar.html",scope:b,backdrop:!1,windowClass:["loadingbar"]});return c}},close:function(){b.$progress&&b.$progress.close(),b.$progress=null}}}]),angular.module("frontendApp").factory("ServerError",["MsgPanel",function(a){return{show:function(b,c,d,e){if(422===b.status){if(b.data.fields){var f=b.data.fields;for(var g in f)c.$broadcast("serverErrorOccurred-"+g,f[g])}return b.data.global&&a.showError(d,b.data.global,e),!0}return!1}}}]),angular.module("frontendApp").factory("ConfirmDialog",["$modal",function(a){var b=["$scope","$modalInstance","headerText","bodyText",function(a,b,c,d){a.headerText=c,a.bodyText=d,a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}],c=function(a,b){return{headerText:function(){return a},bodyText:function(){return b}}};return{confirmDelete:function(d,e,f){return a.open({templateUrl:"template/confirmationdialog/delete.html",controller:b,resolve:c(e,f),scope:d,backdrop:!1})},confirmInfo:function(d,e,f){return a.open({templateUrl:"template/confirmationdialog/info.html",controller:b,resolve:c(e,f),scope:d,backdrop:!1,keyboard:!1})},confirmQuestion:function(d,e,f){return a.open({templateUrl:"template/confirmationdialog/question.html",controller:b,resolve:c(e,f),scope:d,backdrop:!1})}}}]),angular.module("frontendApp").factory("I18n",function(){return{error:{unexpected:"Ups. Niespodziewany błąd, spróbuj ponownie albo poinformuj nas o błędzie - agenda.wro@gmail.com",status0:"Wystąpił problem połączenia z serwerem",status404:"Przykro nam, ale obiekt nie jest dostępny",email:"Podaj poprawny adres e-mail",pwd:"Podaj hasło"},placeholder:{email:"Adres e-mail",pwd:"Hasło"},calendar:{format:"dd-MM-yyyy",shortFormat:"dd.MM",today:"Dziś",weeks:"Tygodnie"},timeFormat:"HH:mm",action:{close:"Zamknij",clear:"Wyczyść"},status:{updated:"Dane zostały zaktualizowane"},login:{heading:"Zaloguj się",rememberMe:"Zapamiętaj mnie",remindMe:"Zresetuj hasło",signin:"Zaloguj",signout:"Wyloguj",signup:"Zarejestruj się",hasAccount:"Nie masz konta?",pros:["+ Będziesz zarządzać wydarzeniami w panelu administracyjnym","+ Twoja organizacja będzie widoczna na głównej stronie na liście organizatorów","+ Użytkownik będzie mógł wyświetlić dane Twojej organizacji przy wydarzeniu"],badCredentials:"Adres email lub hasło są niepoprawne",resetPwd:"Link umożliwiający ustanowienie nowego hasła został wysłany na Twój adres e-mail",statusPwdChanged:"Hasło zostało zmienione"},appName:"kulturalna AGENDA Wrocławia",doneBy:"DaDa Soft Lab 2014",main:{nav:{toggle:"Nawigacja",filters:"Filtry",announcements:"Zapowiedzi"},menu:{events:"Wydarzenia",addEvent:"Zgłoś wydarzenie",adminPanel:"Panel administracyjny",about:"O nas"},categories:"Kategorie",insts:"Organizatorzy w kategorii w wybranym terminie",sort:{title:"Sortuj wg",byTime:"czasu",byTitle:"tytułu"},noEvents:"Brak wydarzeń",soon:"Wkrótce",newest:"Najnowsze wpisy"},event:{where:"Gdzie",price:"Cena",more:"Więcej",del:{title:"Usunięcie wydarzenia",query:"Czy na pewno chcesz usunąć wydarzenie?",confirm:"Wydarzenie zostało usunięte."},uploadError:"Niestety z przyczyn technicznych nie można dodać zdjęcia",addedNew:"Nowe wydarzenie zostało dodane",changeType:{title:"Zmiana typu wydarzenia",query:"Czy na pewno chcesz zmienić typ wydarzenia? Część danych dotycząca terminów zostanie utracona."}},inst:{del:{title:"Usunięcie konta organizatora",query:"Czy na pewno chcesz usunąć konto razem z wszystkimi zgłoszonymi wydarzeniami?",confirm:"Konto zostało usunięte wraz z wszystkimi danymi."}}}}),angular.module("frontendApp").factory("ResponseInterceptor",["$q","$rootScope",function(a,b){var c=function(){b.$progress&&b.$progress.close(),b.$progress=null};return{responseError:function(d){return c(),422!==d.status&&410!==d.status&&b.$broadcast("onUnexpectedServerError",d),a.reject(d)}}}]),angular.module("frontendApp").controller("MainCtrl",["$scope","$location","$anchorScroll","$q","$filter","$cookies","$timeout","$window","$rootScope","$routeParams","Menu","Events","Progressbar","Auth",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(){if("/"===b.url()){var a=f.search;a&&(j=angular.fromJson(a))}delete f.search}function p(a,c){var d=b.search();c?d[a]=c:delete d[a],b.search(d)}function q(a,b,c){for(var d=0;d<a.length;++d)if(a[d][b]==c)return d}function r(a){var b=a.split("-");if(3===b.length){var c=parseInt(b[0]),d=parseInt(b[1])-1,e=parseInt(b[2]),f=new Date;if(f.setFullYear(c,d,e),!isNaN(f.getTime()))return f}}a.toggleRightPanel=function(){a.rightPanel="activeRight"===a.rightPanel?"":"activeRight"},a.toggleLeftPanel=function(){a.leftPanel="activeLeft"===a.leftPanel?"":"activeLeft"};var s="all",t="cal";a.showMaxChars=200;var u=function(){var b=j.s;b||(b="dateTime"),a.changeOrder(b)},v=function(b){var c,d=j.c;return d&&(c=q(a.categories,"id",d)),c>=0?c:b.activeIndex},w=function(b){a.weekMenu.calendar={opened:!1,dateOptions:{"year-format":"'yy'","starting-day":1,"show-weeks":!1}};var c,d=j.cal;if(d)a.weekMenu.calendar.value=d,c=q(a.weekMenu,"type",t);else{var e=j.d;if(e&&(c=q(a.weekMenu,"type",e),void 0===c&&(c=q(a.weekMenu,"id",e),void 0===c))){var f=r(e);f&&(a.weekMenu.calendar.value=f,c=q(a.weekMenu,"type",t))}}return c>=0?c:b.activeIndex};a.changeCategory=function(a){var b=x(a);y(b),z(b)};var x=function(b){a.categories.active&&(a.categories.active.ngClass="");var c=a.categories[b];return c.ngClass="active",c.index=b,a.categories.active=c,p("c",c.id),c},y=function(b){a.categories.filter=b.id!==s?b:void 0},z=function(b){if(a.institutions[b.id]){var c=A(b);c>=0?a.changeInstitution(c):(console.assert(!1,"Cannot find index of 'all' institutions. The first institution was set"),a.changeInstitution(0))}},A=function(b){return q(a.institutions[b.id],"id",s)};a.changeInstitution=function(a){C(B(a))};var B=function(b){a.institutions.active&&(a.institutions.active.ngClass="");var c=a.institutions[a.categories.active.id][b];return c.ngClass="active",a.institutions.active=c,p("i",c.id),c},C=function(b){a.institutions.filter=b.id!==s?b:void 0};a.changeEventsDay=function(b){m.open();var c=D(b),d=a.categories.active,e=E();a.events=[],a.institutions={},F(c,d,e)};var D=function(b){a.weekMenu.active&&(a.weekMenu.active.ngClass="");var c=a.weekMenu[b];return c.ngClass="active",c.index=b,c.type===t?(c.id=e("date")(a.weekMenu.calendar.value,"yyyy-MM-dd"),p("cal",c.id),p("d",null)):(a.weekMenu.calendar.value=null,p("d",c.type?c.type:c.id),p("cal",null)),a.weekMenu.active=c,c},E=function(){var b,c;return a.institutions.active?(b=a.institutions.active,c=b.id):c=j.i,{value:b,id:c}},F=function(b,c,d){l.byDate(b.id,c.id,d.id).then(function(b){K(b.categories),G(d.value,c),L(b),M(b),a.weekMenu.calendar.minDate=b.now,a.events=b.events,a.noEventsMsg=!a.events.length,m.close(),O()})},G=function(a,b){var c;if(a)c=H(b,a.id)||I(a,b);else{var d=j.i;c=d&&H(b,d)}return!c&&z(b)},H=function(b,c){var d=q(a.institutions[b.id],"id",c),e=d>=0;return e&&a.changeInstitution(d),e},I=function(b,c){return b.badge=0,J(b,c),a.institutions.active=b,!0},J=function(b,c){var d=A(c);a.institutions[c.id].splice(d+1,0,b)},K=function(b){angular.forEach(a.categories,function(c,d){c.badge=b[d].badge,a.institutions[c.id]=b[d].who})},L=function(b){b.hasOwnProperty("newest")&&(a.newest=b.newest)},M=function(b){b.hasOwnProperty("soon")&&(a.soon=b.soon)};a.openEventsCalendar=function(b,c){b.preventDefault(),b.stopPropagation(),a.weekMenu.calendar.dayIndex=c,a.weekMenu.calendar.opened=!0},a.$watch("weekMenu.calendar.value",function(b,c){b!==c&&b&&void 0!==a.weekMenu.calendar.dayIndex&&(c?b.getTime()!==c.getTime()&&a.changeEventsDay(a.weekMenu.calendar.dayIndex):a.changeEventsDay(a.weekMenu.calendar.dayIndex))}),a.changeOrder=function(b){a.orderEventsBy=b,p("s",b)},a.displayEvent=function(c,d){a.saveFilters(),f.lastEvent=d+c,b.url("event/"+c)},a.reload=function(){b.search({}),g(function(){h.location.reload()},0)},a.panel=function(c){a.saveFilters(),b.url("panel/"+i.userId),b.search({o:c})},a.about=function(){a.saveFilters(),b.url("about")},a.logout=function(){n.logout()},a.saveFilters=function(){f.search=angular.toJson(b.search())};var N=function(a){g(function(){var d=b.hash();b.hash(a),c(),b.hash(d)},50)},O=function(){var a=f.lastEvent;a&&(delete f.lastEvent,N(a))};a.init=function(){n.checkIfLoggedIn(),o(),u(),a.institutions={},d.all([k.categories(),k.week()]).then(function(b){a.categories=b[0].entries,a.changeCategory(v(b[0])),a.weekMenu=b[1].entries,a.changeEventsDay(w(b[1]))})},a.init()}]),angular.module("frontendApp").controller("EventCtrl",["$scope","$routeParams","$location","Events",function(a,b,c,d){d.byId(b.eventId).then(function(b){a.event=b},function(){c.url("/")})}]),angular.module("frontendApp").controller("PanelCtrl",["$scope","$routeParams","$filter","$location","$modal","Inst","Category","Events","Event","MsgPanel","Uploader","ServerError","Progressbar","ConfirmDialog","Config","Auth",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){function q(b){b&&(a.inst=b),a.inst.repwd=a.inst.password}function r(b){b&&(a.event=b),a.eventTitle=a.event.title}function s(b){t(),a.cancelClicked=function(){a.eventTitle=void 0,a.loadSubmittedEvents()},C(4,b)}function t(){u(),v(),a.partial="panelEvent.html",a.evtMsgPanel={show:!1,messages:[]},a.isMeridian=!1,a.dateOptions={"year-format":"'yy'","starting-day":1,"show-weeks":!1},w()}function u(){g.all().then(function(b){a.categories=b})}function v(){o.now().then(function(b){a.minDate=b.now})}function w(){var b=a.uploader=k.create(a);b.filters.push(function(c){var d=b.isHTML5?c.type:"/"+c.value.slice(c.value.lastIndexOf(".")+1);d="|"+d.toLowerCase().slice(d.lastIndexOf("/")+1)+"|";var e=!(a.event.isNotImg="|jpg|png|jpeg|bmp|gif|".indexOf(d)<0);return e}),b.filters.push(function(b){var c=!(a.event.notOkSize=b.size>3145728);return c}),b.bind("afteraddingfile",function(){b.queue.length>1&&b.removeFromQueue(0),a.event.pic=null})}function x(){var b=a.uploader;b.uploadAll();var c=!0;b.bind("success",function(b,c,d,e){a.event.picId=e.fileId}),b.bind("error",function(){c=!1}),b.bind("completeall",function(){c?y():(j.showError(a.evtMsgPanel,a.i18n.event.uploadError,a.form.event),m.close())})}function y(){var b=function(b){l.show(b,a,a.evtMsgPanel,a.form.event)},c=function(b,c){r(b),a.uploader.clearQueue(),j.showSuccess(a.evtMsgPanel,c,a.form.event),m.close()},d=z();d.id?i.update({id:d.id,picId:a.event.picId},d,function(b){c(b,a.i18n.status.updated)},b):i.save({picId:a.event.picId},d,function(b){s(b.id),c(b,a.i18n.event.addedNew)},b)}function z(){var b=angular.copy(a.event);return angular.forEach(b.pdtps,function(a){a.readonly||(a.fromDate=A(a.fromDate),a.toDate=A(a.toDate),a.startTime=A(a.startTime))}),b}function A(a){return"object"==typeof a?c("date")(a,"yyyy-MM-ddTHH:mm"):a}function B(b){if(a.event.oneTimeType=b,!b)for(var d,e=0;e<a.event.pdtps.length;++e)d=a.event.pdtps[e],d.fromDate=d.toDate,d.timeDescription=c("date")(d.startTime,a.i18n.timeFormat)}function C(b,c){a.option=b;var e={o:b};c&&(e.e=c),d.search(e)}a.logout=function(){p.logout(),d.url("login")},a.loadInst=function(){a.formInstValidations=!1,m.open(),C(1),a.partial="panelInst.html",a.instMsgPanel={show:!1,messages:[]},a.inst=f.get({id:b.instId},function(){q(),m.close(),a.formInstValidations=!0},function(){a.logout()})},a.saveInst=function(){a.form.inst.$invalid||(m.open(),f.update({id:a.inst.id},a.inst,function(b){q(b),j.showSuccess(a.instMsgPanel,a.i18n.status.updated,a.form.inst),m.close()},function(b){l.show(b,a,a.instMsgPanel,a.form.inst)}))},a.deleteInst=function(){n.confirmDelete(a,a.i18n.inst.del.title,a.i18n.inst.del.query).result.then(function(){m.open(),a.inst.$delete({id:a.inst.id},function(){p.logout(),m.close(),n.confirmInfo(a,a.i18n.inst.del.title,a.i18n.inst.del.confirm).result.then(function(){d.url("/")})},function(b){l.show(b,a,a.instMsgPanel,a.form.inst)})})},a.changePwd=function(){var b=e.open({templateUrl:"views/changePwd.html",controller:D,scope:a,backdrop:!1});b.result.then(function(){j.showSuccess(a.instMsgPanel,a.i18n.login.pwdChanged,a.form.inst)})},a.loadNewEvent=function(){a.formEventValidations=!1,C(2);var b=new Date;b.setHours(19),b.setMinutes(0),a.event={pdtps:[{startTime:b}],oneTimeType:!0,canDelete:!0,institution:{id:a.inst.id}},t(),a.cancelClicked=void 0},a.loadSubmittedEvents=function(){C(3),m.open(),a.partial="panelSubmittedEvents.html",h.submitted(b.instId).then(function(b){a.submittedEvents=b.events,m.close()})},a.loadExistingEvent=function(b){a.formEventValidations=!1,m.open(),s(b),a.event=i.get({id:b},function(){r(),m.close(),a.formEventValidations=!0},function(){a.loadSubmittedEvents()})},a.reloadSubmittedEvent=function(){a.loadExistingEvent(a.event.id)},a.deleteEvent=function(){n.confirmDelete(a,a.i18n.event.del.title,a.i18n.event.del.query).result.then(function(){m.open(),a.event.$delete({id:a.event.id},function(){m.close(),n.confirmInfo(a,a.i18n.event.del.title,a.i18n.event.del.confirm).result.then(function(){a.loadNewEvent()})},function(b){l.show(b,a,a.evtMsgPanel,a.form.event)})})},a.removeFromQueue=function(b){a.uploader.removeFromQueue(b),a.event.selectedPic=null},a.removeImage=function(){a.event.pic=null},a.removePdtp=function(b){a.event.pdtps.splice(b,1)},a.isRemovePdtpShown=function(b){return!b.readonly&&a.event.pdtps.length>1},a.addPdtp=function(b){var c={readonly:!1};if(a.event.pdtps.length>0){var d=a.event.pdtps[b];c.startTime=d.startTime,c.price=d.price,c.place=d.place,c.timeDescription=d.timeDescription}a.event.pdtps.splice(b+1,0,c)},a.openCalendar=function(a,b){a.preventDefault(),a.stopPropagation(),b.opened=!0},a.saveEvent=function(){a.formEventValidations=!0,a.form.event.$invalid||(m.open(),a.uploader.getNotUploadedItems().length?x():y())},a.isOneTimeType=function(b,c){b.preventDefault(),b.stopPropagation(),a.event.id&&a.event.oneTimeType!==c?n.confirmQuestion(a,a.i18n.event.changeType.title,a.i18n.event.changeType.query).result.then(function(){B(c)}):B(c)};var D=["$scope","$modalInstance","Auth","ServerError","Progressbar",function(a,b,c,d,e){a.pwdMsgPanel={show:!1,messages:[]},a.pwd={oldPwd:null,newPwd:null,rePwd:null},a.change=function(){a.formPwdValidations=!0,a.form.pwd.$invalid||(e.open(),c.changePwd({pwd:a.pwd.oldPwd,newPwd:a.pwd.newPwd}).then(function(){e.close(),b.close()},function(b){d.show(b,a,a.pwdMsgPanel)}))},a.cancel=function(){b.dismiss("cancel")}}];a.init=function(){a.form={},a.loadInst();var c=parseInt(b.o);2===c?a.loadNewEvent():3===c?a.loadSubmittedEvents():4===c&&b.e&&a.loadExistingEvent(b.e)},a.init()}]),angular.module("frontendApp").controller("LoginCtrl",["$scope","$routeParams","$location","$cookies","$modal","Auth","MsgPanel","Progressbar",function(a,b,c,d,e,f,g,h){a.form={},a.loginMsgPanel={show:!1,messages:[]},a.username=d.username,a.username&&(a.rememberMe=!0),a.login=function(){a.formLoginValidations=!0,a.form.login.$invalid||(h.open(),f.login({username:a.username,password:a.password},a.rememberMe).then(function(a){h.close(),c.url("panel/"+a.id),c.search(b)},function(b){return 403===b.status&&g.showError(a.loginMsgPanel,a.i18n.login.badCredentials,a.form.login)}))},a.resetPwd=function(){var b=e.open({templateUrl:"views/resetPwd.html",controller:i,scope:a,backdrop:!1});b.result.then(function(){a.username=a.password=null,g.showSuccess(a.loginMsgPanel,a.i18n.login.resetPwd,a.form.inst)})};var i=["$scope","$modalInstance","Auth","ServerError","Progressbar",function(a,b,c,d,e){a.pwdMsgPanel={show:!1,messages:[]},a.pwd={username:null},a.reset=function(){a.formPwdValidations=!0,a.form.pwd.$invalid||(e.open(),c.resetPwd({username:a.pwd.username}).then(function(){e.close(),b.close()},function(b){d.show(b,a,a.pwdMsgPanel)}))},a.cancel=function(){b.dismiss("cancel")}}]}]),angular.module("frontendApp").controller("SignupCtrl",["$scope","$location","Inst","ServerError","Progressbar","Insts","$growl",function(a,b,c,d,e,f,g){f.names().then(function(b){a.registeredInsts=b}),a.form={},a.instMsgPanel={show:!1,messages:[]},a.inst={},a.saveInst=function(){a.formInstValidations=!0,a.form.inst.$invalid||(e.open(),c.save({},a.inst,function(a){e.close(),a.id?b.url("panel/"+a.id+"?o=2"):(b.url("/"),g.box(null,a.message,{"class":"success",sticky:!0}).open())},function(b){d.show(b,a,a.instMsgPanel,a.form.inst)}))}}]),angular.module("frontendApp").controller("AboutCtrl",function(){}),angular.module("frontendApp").controller("InvalidConfirmationCtrl",function(){}),angular.module("frontendApp").controller("SignupConfirmationCtrl",["$scope","$routeParams",function(a,b){a.type=b.type}]),angular.module("frontendApp").controller("SetPwdCtrl",["$scope","$routeParams","$location","$growl","Progressbar","Auth","ServerError",function(a,b,c,d,e,f,g){a.pwdMsgPanel={show:!1,messages:[]},a.pwd={newPwd:null,rePwd:null,username:b.username},a.set=function(){a.formPwdValidations=!0,a.form.pwd.$invalid||(e.open(),f.setPwd({pwd:a.pwd.newPwd,token:b.token}).then(function(){e.close(),c.url("/"),d.box(null,a.i18n.login.statusPwdChanged,{"class":"success",sticky:!0}).open()},function(b){410===b.status?c.url("rc/invalid"):g.show(b,a,a.pwdMsgPanel)}))}}]);